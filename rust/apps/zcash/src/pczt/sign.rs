use super::*;
use alloc::format;
use bitcoin::secp256k1::ecdsa::Signature;
use blake2b_simd::Hash;
use rand_core::OsRng;
use zcash_vendor::pczt::pczt_ext::TransparentSignatureDER;

struct SeedSigner<'a> {
    seed: &'a [u8],
}

impl<'a> PcztSigner for SeedSigner<'a> {
    type Error = ZcashError;
    fn sign_transparent(
        &self,
        hash: Option<Hash>,
        key_path: BTreeMap<[u8; 33], Zip32Derivation>,
    ) -> Result<BTreeMap<[u8; 33], TransparentSignatureDER>, Self::Error> {
        let hash = hash.ok_or(ZcashError::InvalidDataError(format!("invalid siging hash")))?;
        let message = Message::from_digest_slice(hash.as_bytes()).unwrap();
        let fingerprint = calculate_seed_fingerprint(&self.seed)
            .map_err(|e| ZcashError::SigningError(e.to_string()))?;

        let mut result = BTreeMap::new();
        key_path.iter().try_for_each(|(pubkey, path)| {
            let path_fingerprint = path.seed_fingerprint.clone();
            if fingerprint == path_fingerprint {
                let my_pubkey = get_public_key_by_seed(&self.seed, &path.to_string())
                    .map_err(|e| ZcashError::SigningError(e.to_string()))?;
                if my_pubkey.serialize().to_vec().eq(pubkey) {
                    let signature = sign_message_by_seed(&self.seed, &path.to_string(), &message)
                        .map(|(_rec_id, signature)| signature)
                        .map_err(|e| ZcashError::SigningError(e.to_string()))?;

                    let sig = Signature::from_compact(signature.as_slice())
                        .map_err(|e| ZcashError::SigningError(e.to_string()))?
                        .serialize_der()
                        .as_ref()
                        .to_vec();
                    result.insert(pubkey.clone(), sig);
                }
            }
            Ok(())
        })?;

        Ok(result)
    }

    fn sign_sapling(
        &self,
        _hash: Option<Hash>,
        _alpha: [u8; 32],
        _path: Zip32Derivation,
    ) -> Result<Option<ZcashSignature>, Self::Error> {
        // we don't support sapling yet
        Err(ZcashError::SigningError(
            "sapling not supported".to_string(),
        ))
    }

    fn sign_orchard(
        &self,
        hash: Option<Hash>,
        alpha: [u8; 32],
        path: Zip32Derivation,
    ) -> Result<Option<ZcashSignature>, Self::Error> {
        let fingerprint = calculate_seed_fingerprint(&self.seed)
            .map_err(|e| ZcashError::SigningError(e.to_string()))?;

        let hash = hash.ok_or(ZcashError::InvalidDataError(format!("invalid siging hash")))?;

        let path_fingerprint = path.seed_fingerprint.clone();
        if fingerprint == path_fingerprint {
            sign_message_orchard(&self.seed, alpha, hash.as_bytes(), &path.to_string(), OsRng)
                .map(|signature| Some(signature))
                .map_err(|e| ZcashError::SigningError(e.to_string()))
        } else {
            Ok(None)
        }
    }
}
pub fn sign_pczt(pczt: &Pczt, seed: &[u8]) -> crate::Result<Vec<u8>> {
    pczt.sign(&SeedSigner { seed })
        .map(|pczt| {
            rust_tools::debug!(format!("pczt: {:?}", hex::encode(pczt.serialize())));
            pczt.serialize()
        })
        .map_err(|e| ZcashError::SigningError(e.to_string()))
}

#[cfg(test)]
mod tests {
    use alloc::{collections::btree_map::BTreeMap, vec};
    use keystore::algorithms::zcash::derive_ufvk;
    use zcash_vendor::pczt::{
        common::{Global, Zip32Derivation},
        orchard::{self, Action},
        sapling, transparent, Pczt, V5_TX_VERSION, V5_VERSION_GROUP_ID,
    };

    use super::*;

    extern crate std;

    const HARDENED_MASK: u32 = 0x8000_0000;

    use std::println;

    #[test]
    fn test_sign_pczt() {
        let pczt = "50435a5401000000058ace9cb502d5a09cc70c0100c6fea70185010001227a636173685f636c69656e745f6261636b656e643a70726f706f73616c5f696e666f140cd612b51afd462f8b19e3edcaf791579efea7010000000000fbc2f4300c01f0b7820d00e3347c8da4ee614674376cbc45359daa54f9b5493e01000000000000000000000000000000000000000000000000000000000000000002605d24c9243562806a1b7503c8ea3d0eb3f4396295315248d88140517dd8773fea6ca8372648dc6c1e05b4fdeea0dcfe3b0193e3c77c8e585c948a72e84f6824f86a91ce32399e91ad444507833972e17cbef20d76d988c196d69a920db49886000114b0cac3e14c4e1a4a4fd22c98563b9cbe859c67768a39f67abd5dbe55d3d16ff58e5c45b21d8c573f54b901d0ad73013590ab44ccbc82f402d607793b1ac222fbfcb592460160cf775e7b469a2ae12901b227285b222e468c8330b7ed6f74728973ebe1a66299f8290690ba906b45eb1d017d6d7535f6e3eade13042662d05eefa91d1f4757fcd0b4b844554e77366f4b36a7068e15c2f06aaa11f6bcfd2e9e36231530069f7fb99a2771050689f24f332b427fdd05d1d5f3219230a1406f0955e3ddc0ef5ce2c7f160d797f3e54ef578200198d4ac17681ab42419ea525c66c4bb2e41463f8b5857ec3e8ffc5859ee86cf0620fbf703ff5732f7e6d0d059f8ec4bb809e8d53f182c0830653ebb25df34d2fce5be6903c769f954c98dbbe8b1eb3f44881b7f1d5d02897ad06be32319ffe3ad955e0027e52a543e27c712aa52157eeae9fe778f66a568915c834bcc182607b57a4e142d667653bda46ff77b414ae5d454a90766517bff58a2c068ea679e1e0125379b18f82523c38db1b57890808fffc45986802010b5d6e56d97a1b6a5e3dbb29dfc27a51047ac3c6f2af836bf2462c4e93770be38490306226b406a878cab85af9c171ac00ceff27fe9c721ba04188dfae2faece945130d039c4f89285d6c76413623c8ec46a78434d9a59d709e6de2892afa1bf826a35848afe9dd99e36457e569304d2d6852d19bd214f7729644b2b68e9956ad31be510ca7d5329b7d647d341010e41966f7aaac3b5788e072daec0e6437eddb94a1a31ab496c3c0c7ec64fa9404fd8d40ccb9fb2e104aa0357a122141052c9a741c4c2c736b6dd0363ddbf27e2922ae2800cb93abe63b70c172de70362d9830e53800398884a7a64ff68ed99e0b9d2e26bdef115ced7bd36305a54386996133c4e65759f3731637a40eba67da103f98adbe364f148b0cc2042cafc6be1166fae39090ab4b354bfb6217b964453b63f8dbd10df936f1734973e0b3bd25f4ed440566c923085903f696bc6347ec0f6f3f63aab58e63b6449583df5658a91972a20291c6311b5b3e5240aff8d7d00212278dfeae9949f887b70ae81e084f8897a5054627acef3efd01c8b29793d522ca2ced953b7fb95e3ba986333da9e69cd355223c929731094b6c2174c7638d2e60040850b766b126a2b4843fcdfdffa5d5cab3f53bc860a3bef68958b5f066177097b04c2aa045a0deffcaca41c5ac92e694466578f5909e72bb78d33310f705cc2dcaa338b312112db04b435a706d63244dd435238f0aa1e9e1598d354708102dcc4273c8a0ed2337ecf7879380a07e7d427c7f9d82e538002bd1442978402cdaf63debf5b40df902dae98dadc029f281474d190cddecef1b10653248a234151f91982912012669f74d0cfa1030ff37b152324e5b8346b3335a0aaeb63a0a2de2bca6a8d987d668defba89dc082196a922634ed88e065c669e526bb8815ee1be8ae2ad91d463bab75ee941d33cc5817b613c63cda943a4c07f600591b088a25d53fdee371cef596766823f4a518a583b1158243afe89700f0da76da46d0060f15d2444cefe7914c9a61e829c730eceb216288fee825f6b3b6298f6f6b6bd62e4c57a617a0aa10ea7a83aa6b6b0ed685b6a3d9e5b8fd14f56cdc18021b12253f3fd4915c19bd831a7920be55d969b2ac23359e2559da77de2373f06ca014ba2787d063cd07ee4944222b7762840eb94c688bec743fa8bdf7715c8fe29f104c2a0105f3600ab15c6f1c087eaf89f57e650b1e7a603d5414de3a81af8292a2af183b012fac20755b7bb7c99d302b782ea36f62a1b0cfe8d7d4d09a58e8ba5da26f457803a08080800885818080088080808008000080bcba8fd36661ebe7b37230e7f3e04c48542cf1a0c3388ff0873c5faa5a992651270a6151797049162f9be38403e86480188acfd569daf4f9c537c29add78afc404520d3c23751e0450890c02250cc144c0dad537b464f0f85034a5b730ba70c6d81ae4261a29937aba79fa72f9eb404d07238e84f21fbfe64e3d2d7b65f934253e1b97bfe8f67c31725ea8527110038cc9b1ed922cb9c23638f2972bd6b04c4a376bbed6d24fb51abbdbc498d5a114e8664bf11296751218c2696b2606093de8bdb94972edf34a3c59b8f18210651233ed0d92014c81782cee5e06540c2cc05580e41ec72e3523c2654ccad3c73c8ada5b2498011365d83475058ff82f1fad89b445075f512b08a57ca977e490cc033e91e27e42f20009af72b6d53855681b671d5662783f5440aaa08fd69821d826b180ac2a728e7d8c364614eedfce34bef6280141783ead439d162218e0872c9514ebd6b19e723e2324b2021f871ce5459b7a1267828b3c00c7dd7ecf6c08e37e717588b42e18efc7a14a72e105843f051bfddb1bd4f0e9dd4f59bc7809a546dbd1d5269ab64486f85ca80a6e0a7a88c0c6bd18654bde21e964cec1331a68006c5ede67c92831ceaf192b9e44f07e62f8156ecc2d8bf07b4b552db9e7f3e5648a662b5165282ee27640ea7f6019336ff50713eaad3f511cb6f950148e58ea1f353833a6fccaff3c895f294ae5f636245853d991d442ca02589ae90d44c4683bc12391ce555d319bd3a6c614d3d71bbcb1f9b3ad3107e5f93ca35f718ec89fed151624c38bef99c7bdd83eee9aa96d92d645c4b23b65fb79a995df9948a64df883b1f3a807b938f61afee72656592ac8ae3e4170ab64de085b4c300f1dabef73c21a649ca373f70ba0d53ea0cf26c793e9a2d0ae3c2fbd50d21d1b14c3387d528299c9d37e269a7516a5a9ab9bce7e7b6e709aa58db1677647b17d3b2946a0e57de3dc5ece4917679cbeb2d586bfa7d169995524de21a86d60efa9903fde28b999a16b698fa989330199a66f4d2212d15f6b9ddf1d738b41226e3954130fee9e1654409d3eb52a82e0e18f62bb13bab4f37db92901a08d0601e052bb9fdbf4f233adc2221f19fb24637494f466108a5329370dd30c1341a3c6000001207a636173685f636c69656e745f6261636b656e643a6f75747075745f696e666fd80100d50175316677787573387a63687136343772346a61717833327537736a32777479706c7376756e336a6563613272633477353575387572736e337132773438377634756d6b686738776c727465726e686e3064776761707471683537327566306b357078736d717a75726633336671677868353375616a6b7472683377733735677766786c65677537686e676839726c6c743635636e7568393675766d65336366346b663366357938737936396a39356e6c7370726176396d3977336d7a6c336b757663306d6874716d3074746c71716a6d786735357501d381b40829d450b45b41844f3a018bf3c8605285baf8a484ed92e58bafc241219789437d1286951ebaa210cb384a658bca1ecae2429174c0c9f354804802818efbd865eb0609f8d779f06086d7a0ce6a2203fd074dd7fd1e7239c6d145f8113a22252861231b3a40d74ff3b23bfbda0a865fdaf8efbdc0e09edaa096b13df08c017890ba7b365f5837585fa213c580bc75e88bbccaf301bd4f88046f12681f17b3128b4270f06ab727bc9c0a53192fac26d277b1589ac141c35245aa5dd5586e26010d79aa242f3ee18cedd2f8bf9e43675a1a0e856d454a1e1371b87c20278f20db4381faa08495c348f08336010001f13726573dbb1cfd6384e47fcc8678ab7e56ab8abfd872b267bea799cc78602c0169b9da089a769593b63fdb5abb883c5c20e69ce5c05a74999e25338cded3920101dbdf8a657607f449b9f88c32bdfd4d73e97cd523f4d317c1a769eb69373cb93da8d91a6391b6914c17bd05b2fe808b73e48fde3360032163c6573235c3dd703bb7e66d8fc5544a369142c98948ccde9f17c21a0381c42bb2e9187e51ac8e613d01e09efcb90d9300f2ada3b85a1eeac5437c3659bacf88d33a2f9f87265b87e9c6061c7b3c27b0abf551c81061d942051009f6decb8e0118effd4316c2696a240ff3f55f483a79ebe0861cfd7d8b4afac6d8e6e7b78de86f2afd72a9bbc63be9f0083e6b0306baefa79b7e1e35f3a63d83b7d06ae43faa8d4456ab494599ff05adfe9f80a40a66c65fd35630b8fb51a5245f48062fa340567f5ab6df5a602de02f433cf4ab3dcaa7b975f57ee389352efbb1633961520338091b699a4dd8c0adb2550309ca3788b928ae68362cde34c2ebef5201d91bae878fa2c37833d163e8e7cd05dd5d3f05f83215fea674601ba60175c45b391df8afe9c9c827dde5832475ea4413fd1628870c039f1527e78a5368455004f648a8f9479345aeaa2b60e066832bb44334be4e530721a57d9ae64e2507a81b840f8a750b6c19ad9dc32d69b0838a256f2501d4e2c9c7458b3d32fa546e9fad489a4382009060123032ccdec3ba3961880946e5290f799f657d13e0d48899a33cfaacff3a80f398695590806486a20a6c35e3e8a721b58a3b7adce18a505b7a2a1e11d75b150d108ea196476eea4aeefb2b12d27e209ff9f6b1837e403bec3a2e402b1a68ac03210724261a326eebec782bc047b8b6e796354d422972657290f2564c3e90c8b36460ab0c51eb9fbd1a0630e2e123ec45325cc934f3344f002e0791c752d355a2e5d5fdccce5e3abe130a09cb318eb7a3da6f460b6ed4f8d364f52b85eda97f93294cb449914d9207e443328482e5f86f3bb4ca72e03398c5a4e393ad39492920213db32ebee184095350321ae14e3be3671e6d07cc0ad640d2db978b25b6bc04a0d68516fe558619c12815646f53055672996e1334428388b8f5a30d6cef40ff1f05198cbee2deb3608c0f67e9750d1a6289440a916f9689722683d873c0efd256f701c98ad499402e91094e6f4e74aac11863018f7d19054a34b183485c3d369b95f5792c2f5d50a8a904ea891c0ed9b5a973918342c2696de2013fa26872fa5fd817717664383248651fe354b9bb91472cddad11ad596b577363d620cf13ff8a9b3d5ef97a31ccead80e705f89ea60dd32bf1135301d42e86f185daa22339bb7e6d1d3e06af075012a27992b3f1f879a952eb6e268f488c01cdebb9bd62358eef30e9a111cdbe6bbdb15859ba98994f91c0bde9dba3893024c7ea02344631ffcfe43e7949811f8fda71e23357f09ac6b6714c0b3fd54abbfe57f7cacbbd130366caf02aea81d04286b3fda4a367fdd570d5386db0c00d2233c56fbd843a574f28ac892e7be90d8b27b28d00e653e22daa40ccd4fc7232587bcc0153d970d8babacf6c9ad7e909c1608099246d50c0b0aad8cad51de4d80f17eb5b242ebe3a000ffd6eccbf5c0bb217d3a872c8b13a6cdde0dc5cf5b4482224c8b3a525cd220763b48058aa3f923be77260113ccd027c9462d45a7c115af3c2c1ff7afb33104cb6127ac3e4517ab00209e040000007c555a81595ae184b8904d286ff94325561f525db19ccf836663d1532b06a712d5ec7de472661db5c089560e95397ba36d68e27fe1327d9771a3b0fe814a231ec404e63e87fa1d7757b1bc89d74d08116434710eea9cd052ba91d0dd030c397f390dbc3ac7e81f616443f9fcc7e5165629c3ed1793dd8102e88de6f9f511dcd5fb6b829774da28cdc7c712896dac62672c9fa019f8ef45ea3a532a815dc8e3c4377437202d2cf146b419eeb4907cd45b7b7c33940ca9aee99df5dbebb98b2b7efc38c8454c77f012651bbb1937098ff6396b2b0315172b3098fa8d7bda0c420a4b6d7b2aab7eb3f17e70e0f34ab2454922a4b39c88a23b2b510c09c0ed5d37f468db5594e07be50a7f84bd08cae1936bf42a4a2a58ccb6e0b665ca12682b5595804b4e9ba01865c1d4996191445af6ca392c2c60a64166b6d7ca8509b689bec123cbc1de6a3653623c29a9fff626147546068f7ab5f3dd5bdac6e25124b1b3a000b21c68ee5090475f327359ffbd7866c85780c663787f963a301ec1eb67d618fa47b1a624de3535579c59f2dc6e86e0ee3967c0ac3bf03bd45479e3d392c4df3688a3e7830ebdb14d16793e543dc6267cd0fc0c8919fae1e0f60d5c554396801032e413572c9f2d8c253b219bddeae1ef9fad78d84573d666fc6a274f049cb58f060ec897cb5e1ba3bef50035d6edb094eafec35af418007650dbe0956972476ea3ca5b668b5386c770e0d44f798dc734fc116784cf429fcc11da7bca16b8bcc16fc4fc25207fb22fe67d82973c8218e151d9abb2385ec9a9d9c29fdf38772646b9b5965773f4c7d9e4e5cf3556fc666f8db1d2db0a816d235c04c06799f3127cc1afcfed39d8e4335678335df5147db11f38ab6dd9e4947cb8d46f28c05253312e0707095a50ff586c7187a4da407f5f7c00469ab40b292ca7b2750924ee64c0dd5687454c643b3cd09de529e85aef0c43ebee5191b4d0ed49c33e58345933cfab3153f7b5e867b0b415d22b6950fc846246f4be91c80114b0cac3e14c4e1a4a4fd22c98563b9cbe859c67768a39f67abd5dbe55d3d16ff58e5c45b21d8c573f54b901a0d26c01ce735088089ccc3d9aba0f224b8dcb8073ed9bea70ba1f8ad83ae66b5635c9ad000001207a636173685f636c69656e745f6261636b656e643a6f75747075745f696e666f12020cd612b51afd462f8b19e3edcaf7915700011e967b51143ea4006830fd2d55801278cce4c6838916506e43a2095107c5103203904e005c6640f7ca57dd7a466a291f1806be6fd0daac702b3162000abc03b05521da3e0001f017305a1c27ae28e6c8ec7393e8564995451909440ff5f23035efdcb6875213";

        let seed = "0000000000000";

        let seed = hex::decode(seed).unwrap();

        let ufvk = derive_ufvk(&seed).unwrap();
        println!("ufvk: {}", ufvk);

        let seed_fingerprint = calculate_seed_fingerprint(&seed).unwrap();
        println!("seed_fingerprint: {:?}", hex::encode(seed_fingerprint));

        let pczt = Pczt::parse(&hex::decode(pczt).unwrap()).unwrap();
        // println!("rk: {}", hex::encode(pczt.orchard().actions()[0].spend().rk()));
        // //6122d6b5ddcc9eb600a4cedb98932b3a7edf6e8b51bc4478b296450bda68c506
        // println!("alpha: {:?}", hex::encode(pczt.orchard().actions()[0].spend().alpha().unwrap()));

        let result = sign_pczt(&pczt, &seed).unwrap();

        println!("result: {:?}", hex::encode(result));
    }
}
